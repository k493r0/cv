name: Build and Reease Latex PDF
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - root_file: onepage/main.tex
            pdf_file: YukiK_onepage.pdf
          - root_file: twopage/main.tex
            pdf_file: YukiK_twopage.pdf

    steps:
      - name: Set up Git repository
        uses: actions/checkout@v2

      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v3
        with:
          root_file: ${{ matrix.root_file }}
          args: -pdf -file-line-error -interaction=nonstopmode -f
        continue-on-error: true

      - name: Rename output PDF
        run: mv main.pdf ${{ matrix.pdf_file }}

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.pdf_file }}
          path: ${{ matrix.pdf_file }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v2

      - name: Write commit hash to version file
        run: echo "${{ github.sha }}" > version

      - name: Download PDFs
        uses: actions/download-artifact@v3
        with:
          path: ./
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y.%m.%d')"

      - name: Get release count for the day
        id: get-release-count
        run: |
          releases=$(gh release list --limit 100)
          count=$(echo "$releases" | grep -c "${{ steps.date.outputs.date }}.")
          echo "::set-output name=count::$(($count + 1))"

      - name: Set tag and release name
        id: set-tag-release
        run: |
          echo "::set-output name=tag::${{ steps.date.outputs.date }}.${{ steps.get-release-count.outputs.count }}"
          echo "::set-output name=release_name::Release ${{ steps.date.outputs.date }}.${{ steps.get-release-count.outputs.count }}"

      - name: Get current time
        uses: josStorer/get-current-time@v2.0.2
        id: current-time
        with:
          utcOffset: "+10:00"

      - name: Create GitHub Release
        run: |
          set -x
          assets=()
          for asset in ./*.pdf; do
            assets+=("$asset")
          done
          gh release create "${{ steps.set-tag-release.outputs.tag }}" "${assets[@]}" --notes "Updated on ${{ steps.current-time.outputs.time }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
